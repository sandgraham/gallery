<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<style>
    * {
        box-sizing: border-box;
    }
    body {
        margin: 0;
        font-size: 1em;
    }
    .grid {
        display: flex;
        flex-flow: row wrap;
        justify-content: space-between;

        padding: 1rem;
    }
    .node {
        height: calc(50vw - 1.25rem);
        width: calc(50vw - 1.25rem);
        margin-bottom: .5rem;

        background: pink;
    }
    .gallery,
    .gallery .node {
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;

        width: 100vw;
        height: 100vh;

        margin: 0;
        padding: 0;
    }
    .animate .node {
        transition: .3s ease-in-out;
    }
    .front {
        z-index: 1;
    }
</style>

<div class="view grid animate">
    <div class="node">0</div>
    <div class="node">1</div>
    <div class="node">2</div>
    <div class="node">3</div>
    <div class="node">4</div>
    <div class="node">5</div>
    <div class="node">6</div>
    <div class="node">7</div>
    <div class="node">8</div>
</div>

<script src="lib/hammer.min.js"></script>
<script>
    // defs

    var view = document.querySelector('.view');
    var nodes = document.querySelectorAll('.node');

    var PAN_LIMIT = 20;
    var PAN_WIDTH = document.body.clientWidth + 100;

    var currentIndex = 0;

    var positionNode = function (node) {
        node.style.top = node.nTop = node.offsetTop;
        node.style.left = node.nLeft = node.offsetLeft;
        setTimeout(function() {
            node.style.position = 'absolute';  
        }, 300);
    }

    var createTapManager = function (node, index) {
        var nodeHammer = new Hammer.Manager(node);
        nodeHammer.add( new Hammer.Tap() );
        nodeHammer.on('tap', function(){
            if (view.classList.contains('gallery')) {
                toggleDetails();
            } else {
                openGallery(index);
            }
        });
    }

    var toggleDetails = function () {
        // for now close
        closeGallery();
    }

    var openGallery = function (index) {
        view.classList.add('gallery');

        nodes[index].classList.add('front');

        for (var i = 0; i < nodes.length; i++) {
            nodes[i].style.top = 0;
            nodes[i].style.left = 0;
        }

        show(index, 0, true);
    }

    var closeGallery = function () {
        view.classList.add('animate');
        view.classList.remove('gallery');

        var translate = 'none';
        for (var i = 0; i < nodes.length; i++) {
            nodes[i].style.top = nodes[i].nTop;
            nodes[i].style.left = nodes[i].nLeft;
            nodes[i].style.transform = translate;
            nodes[i].style.mozTransform = translate;
            nodes[i].style.webkitTransform = translate;
        }

        setTimeout(function(){
            nodes[currentIndex].scrollIntoViewIfNeeded();
            nodes[currentIndex].classList.remove('front');
        }, 200)
    }

    var show = function (showIndex, percent, animate) {
        showIndex = Math.max(0, Math.min(showIndex, nodes.length - 1));
        percent = percent || 0;

        if (animate) {
            view.classList.add('animate');
            // detailTitle.textContent = imageTitles[showIndex];
        } else {
            view.classList.remove('animate');
        }

        document.querySelector('.front').classList.remove('front');
        nodes[showIndex].classList.add('front');

        var pos, translate;
        for (var i = 0; i < nodes.length; i++) {
            pos = (PAN_WIDTH / 100) * (((i - showIndex) * 100) + percent);

            translate = 'translate3d(' + pos + 'px, 0, 0)';

            if (i !== showIndex) {
                translate += ' scale(.8)'
            }

            nodes[i].style.transform = translate;
            nodes[i].style.mozTransform = translate;
            nodes[i].style.webkitTransform = translate;        
        }

        currentIndex = showIndex;
    }

    var pan = function (ev) {
        if (!view.classList.contains('gallery')) return;

        var delta = ev.deltaX;
        var percent = (100 / PAN_WIDTH) * delta;
        var animate = false;

        if (ev.type == 'panend' || ev.type == 'pancancel') {
            if (Math.abs(percent) > PAN_LIMIT && ev.type == 'panend') {
                currentIndex += (percent < 0) ? 1 : -1;
            }
            percent = 0;
            animate = true;
        }

        show(currentIndex, percent, animate);
    }

    // init
    // run through nodes
    // make nodes absolute
    // create tap manager
    for (var i = 0; i < nodes.length; i++) {
        var node = nodes[i];
        positionNode(node);
        createTapManager(node, i);
    }

    viewHammerManager = new Hammer.Manager(view);
    viewHammerManager.add(new Hammer.Pan({ direction: Hammer.DIRECTION_HORIZONTAL, threshold: 10 }));
    viewHammerManager.on('panstart panmove panend pancancel', pan);
</script>
